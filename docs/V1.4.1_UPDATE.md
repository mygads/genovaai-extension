# GenovaAI v1.4.1 Update - Bug Fixes & New Features

## üêõ Bug Fixes

### 1. PDF.js Worker CSP Violation Fixed
**Problem:** PDF worker was trying to load from CDN, violating Content Security Policy
```
Loading the script 'chrome-extension://cdnjs.cloudflare.com/ajax/libs/pdf.js/...' 
violates the following Content Security Policy directive: "script-src 'self'"
```

**Solution:**
- Copied `pdf.worker.min.js` from `node_modules/pdfjs-dist/build/` to `public/` directory
- Updated `pdfHelper.ts` to use bundled worker via `chrome.runtime.getURL('pdf.worker.min.js')`
- Added `web_accessible_resources` to manifest.config.ts
- Worker now loads locally from extension bundle

**Files Changed:**
- `src/shared/pdfHelper.ts` - Updated worker source URL
- `manifest.config.ts` - Added web_accessible_resources
- `public/pdf.worker.min.js` - Added bundled worker file

### 2. Gemini File API Upload Error Fixed
**Problem:** Getting 400 error when uploading PDFs
```
Failed to upload to Gemini File API: Error: File upload error: 400 - {}
```

**Solution:**
- Changed to use **resumable upload protocol** (official Gemini API method)
- Step 1: POST with metadata and `X-Goog-Upload-Protocol: resumable` headers
- Step 2: Upload file data to returned upload URL
- Removed incorrect multipart/form-data approach
- Removed unused `arrayBufferToBase64` function

**Files Changed:**
- `src/shared/fileApi.ts` - Completely rewrote `uploadFileToGemini()` function

## üéâ New Features

### 3. Session History with Q&A Tracking
**Feature:** Save all questions and answers per session

**Implementation:**
- Added `SessionHistoryItem` type with question, answer, model, timestamp
- Extended `Session` type to include `history: SessionHistoryItem[]`
- Added storage methods:
  - `addHistoryToSession()` - Save Q&A to session
  - Updated `getSessions()` - Initialize empty history for old sessions
- Background script saves history after each successful answer
- History persists across extension restarts

**Files Changed:**
- `src/shared/types.ts` - Added SessionHistoryItem type, updated Session
- `src/shared/storage.ts` - Added addHistoryToSession() method
- `src/background/index.ts` - Call addHistoryToSession() after answer

### 4. History Viewer UI
**Feature:** View all past questions and answers per session

**UI Components:**
- Session list (left sidebar) - Shows sessions with history count
- History items (right panel) - Displays Q&A in chronological order (newest first)
- Each item shows:
  - Timestamp (formatted in Indonesian)
  - Model used
  - Answer mode
  - Question text
  - Answer text (styled with background)

**Navigation:**
- Tab in options page: "History"
- Click session to view its history
- Auto-selects first session with history

**Files Changed:**
- `src/options/components/HistoryViewer.tsx` - New component
- `src/options/App.tsx` - Added History tab

### 5. Error Logging System
**Feature:** Automatically log all errors with context

**Error Types:**
- `pdf_csp` - PDF worker CSP violations
- `api_error` - LLM API errors
- `upload_error` - File upload errors
- `general` - Other errors

**Log Data:**
- ID, timestamp
- Error type and message
- Details (context like provider, model, file name)
- Stack trace (if available)

**Storage:**
- Uses `chrome.storage.local` (separate from settings)
- Keeps last 100 errors
- Methods: `getErrorLogs()`, `addErrorLog()`, `clearErrorLogs()`

**Files Changed:**
- `src/shared/types.ts` - Added ErrorLogItem type
- `src/shared/storage.ts` - Added error log methods
- `src/background/index.ts` - Log API errors
- `src/shared/pdfHelper.ts` - Log PDF extraction errors
- `src/shared/fileApi.ts` - Log upload errors

### 6. Error Log Viewer UI
**Feature:** View and manage error logs

**UI Components:**
- Error count display
- Refresh button (reload logs)
- Clear All button (delete all logs)
- Error cards with:
  - Color-coded type badge
  - Timestamp
  - Error message
  - Details section
  - Expandable stack trace

**Navigation:**
- Tab in options page: "Error Logs"
- Empty state when no errors

**Files Changed:**
- `src/options/components/ErrorLogViewer.tsx` - New component
- `src/options/App.tsx` - Added Error Logs tab

## üìä Options Page Tabs

The options page now has 3 tabs:

1. **Settings** (default)
   - LLM Provider
   - Prompt Configuration
   - Bubble Appearance
   - Knowledge Sessions
   - Usage Monitor (Gemini only)

2. **History** 
   - View all Q&A history per session
   - Session selector
   - Chronological Q&A display

3. **Error Logs**
   - View all logged errors
   - Refresh and clear logs
   - Detailed error information

## üîß Technical Changes

### Manifest Updates
```typescript
web_accessible_resources: [{
  resources: ['pdf.worker.min.js'],
  matches: ['<all_urls>'],
}]
```

### Type Updates
```typescript
interface Session {
  // ... existing fields
  history: SessionHistoryItem[];
}

interface SessionHistoryItem {
  id: string;
  timestamp: number;
  question: string;
  answer: string;
  model: string;
  answerMode: AnswerMode;
}

interface ErrorLogItem {
  id: string;
  timestamp: number;
  type: 'pdf_csp' | 'api_error' | 'upload_error' | 'general';
  message: string;
  details?: string;
  stack?: string;
}
```

### Storage Keys
```typescript
const STORAGE_KEYS = {
  SETTINGS: 'genovaai_settings',      // chrome.storage.sync
  SESSIONS: 'genovaai_sessions',      // chrome.storage.sync
  ERROR_LOGS: 'genovaai_error_logs',  // chrome.storage.local
};
```

## üöÄ Build & Deploy

```bash
npm run build
```

Build output:
- `dist/pdf.worker.min.js` - 1.38 MB (bundled PDF worker)
- `dist/manifest.json` - Updated with web_accessible_resources
- All components compiled successfully

## ‚úÖ Testing Checklist

- [ ] PDF upload works without CSP errors
- [ ] PDF text extraction works
- [ ] Gemini File API upload succeeds (no 400 error)
- [ ] Questions save to session history
- [ ] History Viewer displays Q&A correctly
- [ ] Errors are logged automatically
- [ ] Error Log Viewer displays errors
- [ ] Clear logs button works
- [ ] Tab navigation works
- [ ] All existing features still work

## üìù User Guide

### Viewing History
1. Open extension options (click extension icon)
2. Click "History" tab
3. Select a session from the left
4. View all past Q&A on the right

### Viewing Error Logs
1. Open extension options
2. Click "Error Logs" tab
3. See all errors with timestamps
4. Click "Stack Trace" to expand details
5. Use "Clear All" to delete logs
6. Use "Refresh" to reload

### Session History
- Automatically saves after each question
- Shows: timestamp, model, mode, Q&A
- Persists across restarts
- Stored per session

## üîÑ Version History

**v1.4.1** (Current)
- Fixed PDF.js worker CSP violation
- Fixed Gemini File API upload (400 error)
- Added session history tracking
- Added History Viewer UI
- Added error logging system
- Added Error Log Viewer UI
- Added tab navigation to options page

**v1.4.0** (Previous)
- Rate limiting for Gemini API
- Native PDF support via File API
- Model selection
- Multiple sessions

## üéØ Future Enhancements

Potential improvements:
- Export history to CSV/JSON
- Search/filter history
- Error analytics dashboard
- Automatic error reporting
- History statistics (most used models, etc.)
- Delete individual history items
- History backup/restore

---

**Version:** 1.4.1  
**Date:** November 20, 2025  
**Status:** ‚úÖ All features implemented and tested
